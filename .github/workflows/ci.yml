name: CI

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make scripts executable
        run: |
          find . -type f -name "*.sh" -exec chmod +x {} \;

      - name: Run linting checks
        run: |
          make lint
        continue-on-error: false

      - name: Run format checks
        run: |
          make format
        continue-on-error: false

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup detect-secrets
        run: |
          pip install detect-secrets

      - name: Create secrets baseline if missing
        run: |
          if [ ! -f .secrets.baseline ]; then
            detect-secrets scan --baseline .secrets.baseline
          fi

      - name: Audit secrets baseline
        run: |
          detect-secrets audit .secrets.baseline --report --json || true

      - name: Run pre-commit security hooks
        uses: pre-commit/action@v3.0.0
        continue-on-error: false

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Make scripts executable
        run: |
          find . -type f -name "*.sh" -exec chmod +x {} \;

      - name: Run tests
        run: |
          make test || echo "No tests to run, skipping..."

      - name: Run Python tests (if pytest exists)
        if: contains(github.event.head_commit.message, 'python') || contains(github.event.head_commit.message, 'test')
        run: |
          if [ -f requirements.txt ] || [ -f setup.py ] || [ -f pyproject.toml ]; then
            pip install pytest pytest-cov || true
            pytest --version || echo "pytest not available"
          fi
        continue-on-error: true
